# Generic metadata about this project
name: prefect-monorepo
prefect-version: 2.14.3

# build section allows you to manage and build docker images
build:

# push section allows you to manage if and how this project is uploaded to remote locations
push:

# pull section allows you to provide instructions for cloning this project in remote locations
pull:
- prefect.deployments.steps.git_clone: &clone_repo
    repository: https://github.com/zzstoatzz/prefect-monorepo
    branch: main

# File for configuring project / deployment build, push and pull steps
definitions:
  work_pools:
    k8s_work_pool: &k8s_work_pool
      name: k8s
      work_queue_name: default
      job_variables:
        image: '{{ build_image.image }}'
    local_work_pool: &local_work_pool
      name: local
    cloud_run_work_pool: &cloud_run_work_pool
      name: cloud run sandbox

  schedules:
    every_ten_minutes: &every_10_minutes
      interval: 600
    minutely: &minutely
      rrule: FREQ=MINUTELY
  actions:
    dev_clone: &dev_clone
    - prefect.deployments.steps.git_clone:
        repository: https://github.com/zzstoatzz/prefect-monorepo
        branch: dev
    docker_build: &docker_build
    - prefect_docker.deployments.steps.build_docker_image:
        id: build-image
        requires: prefect-docker>=0.3.11
        image_name: zzstoatzz/prefect-monorepo
        tag: latest
        dockerfile: Dockerfile.demo
    docker_push: &docker_push
    - prefect_docker.deployments.steps.push_docker_image:
        id: push-image
        requires: prefect-docker>=0.3.11
        image_name: zzstoatzz/prefect-monorepo
        tag: latest

deployments:
- name: healthcheck-demo
  entrypoint: src/demo_project/healthcheck.py:healthcheck
  schedule: *minutely
  parameters:
    message: Don't panic!
  work_pool: *local_work_pool
  pull:
  - prefect.deployments.steps.git_clone:
      <<: *clone_repo
  - prefect.deployments.steps.run_shell_script:
      script: echo "Hello from the healthcheck-demo project!"

- name: healthcheck-demo-cloud-run-v2
  entrypoint: src/demo_project/healthcheck.py:healthcheck
  schedule: *minutely
  parameters:
    message: Don't panic!
  work_pool: *cloud_run_work_pool
  pull:
  - prefect.deployments.steps.git_clone:
      <<: *clone_repo
  - prefect.deployments.steps.run_shell_script:
      script: echo "Hello from the healthcheck-demo project!"

- name: healthcheck-docker-test
  entrypoint: src/demo_project/healthcheck.py:healthcheck
  schedule: *every_10_minutes
  work_pool: *k8s_work_pool
  build: *docker_build
  push: *docker_push

- name: healthcheck-storage-test
  entrypoint: src/demo_project/healthcheck.py:healthcheck
  work_pool:
    name: local
  version:
  tags: []
  description:
  parameters: {}

- name: random-flow
  entrypoint: src/demo_project/test.py:random_flow
  work_pool:
    name: local
  pull: *dev_clone